<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Coordinate Transformations in gggenes • gggenes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Coordinate Transformations in gggenes">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gggenes</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.6.0.9006</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/coordinate-transformations.html">Coordinate Transformations in gggenes</a></li>
    <li><a class="dropdown-item" href="../articles/introduction-to-gggenes.html">Introduction to 'gggenes'</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/wilkox/gggenes/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Coordinate Transformations in gggenes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/wilkox/gggenes/blob/master/vignettes/coordinate-transformations.Rmd" class="external-link"><code>vignettes/coordinate-transformations.Rmd</code></a></small>
      <div class="d-none name"><code>coordinate-transformations.Rmd</code></div>
    </div>

    
    
<p>This vignette is intended as a reference for gggenes development. It
explains the internal coordinate transformation pipeline and the
rationale behind its design. If you are not planning to make changes to
gggenes, you probably don’t need to read this.</p>
<div class="section level2">
<h2 id="the-problem">The Problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>gggenes geoms need to combine two types of measurements:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Data-derived coordinates</strong> (e.g. gene positions
defined with <code>xmin</code> and <code>xmax</code>) that scale with
the plot axes</li>
<li>
<strong>Absolute measurements</strong> (e.g. arrowhead dimensions
defined in millimetres) that remain constant regardless of plot
size</li>
</ol>
<p>This creates a challenge because ggplot2’s standard approach of
transforming data coordinates in <code>draw_panel()</code> doesn’t work
when absolute measurements are involved. At <code>draw_panel()</code>
time, the viewport doesn’t exist yet, so there’s no way to convert “4
mm” to native coordinate units. Even if we could, resizing the plot
would invalidate the calculation without re-running
<code>draw_panel()</code>.</p>
</div>
<div class="section level2">
<h2 id="the-solution-deferred-rendering">The Solution: Deferred Rendering<a class="anchor" aria-label="anchor" href="#the-solution-deferred-rendering"></a>
</h2>
<p>gggenes solves this by deferring grob construction to render time
using grid’s <code>makeContent()</code> mechanism:</p>
<ol style="list-style-type: decimal">
<li>
<code>draw_panel()</code> packages the raw data, <code>coord</code>,
and <code>panel_scales</code> into a <code>gTree</code> with a custom
class</li>
<li>
<code>makeContent()</code> is called by grid at render time, when
the viewport exists and unit conversions are valid</li>
<li>The actual geometry is constructed and converted to grid coordinates
inside <code>makeContent()</code>
</li>
</ol>
<p>This ensures that absolute measurements are correctly converted
regardless of plot size, and that resizing triggers a fresh
conversion.</p>
</div>
<div class="section level2">
<h2 id="the-alongaway-abstraction">The Along/Away Abstraction<a class="anchor" aria-label="anchor" href="#the-alongaway-abstraction"></a>
</h2>
<p>gggenes supports three coordinate systems: Cartesian, flipped
(<code><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip()</a></code>), and polar (<code><a href="https://ggplot2.tidyverse.org/reference/coord_radial.html" class="external-link">coord_polar()</a></code>).
Rather than writing separate geometry logic for each, the package uses
an abstraction called “along/away”:</p>
<ul>
<li>
<strong>Along</strong>: The direction along the molecule
backbone</li>
<li>
<strong>Away</strong>: The direction perpendicular to the
backbone</li>
</ul>
<p>This maps to different axes depending on the coordinate system:</p>
<table class="table">
<thead><tr class="header">
<th>Coordinate System</th>
<th>Along</th>
<th>Away</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Cartesian</td>
<td>x (horizontal)</td>
<td>y (vertical)</td>
</tr>
<tr class="even">
<td>Flipped</td>
<td>y (vertical)</td>
<td>x (horizontal)</td>
</tr>
<tr class="odd">
<td>Polar</td>
<td>theta (angle)</td>
<td>r (radius)</td>
</tr>
</tbody>
</table>
<p>With this abstraction, geometry can be defined once in along/away
terms and then transformed appropriately for any coordinate system.</p>
<p>The following diagram illustrates the full transformation pipeline
for each coordinate system:</p>
<pre><code>                        TRANSFORMATION PIPELINE

┌─────────────────────────────────────────────────────────────────────────────┐
│                              RAW DATA                                       │
│                    (xmin, xmax, y in data units)                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                          coord$transform()
                                    │
          ┌─────────────────────────┼─────────────────────────┐
          │                         │                         │
          ▼                         ▼                         ▼
┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
│     CARTESIAN     │   │      FLIPPED      │   │       POLAR       │
├───────────────────┤   ├───────────────────┤   ├───────────────────┤
│ along = x (NPC)   │   │ along = y (NPC)   │   │ along = θ (rad)   │
│ away  = y (NPC)   │   │ away  = x (NPC)   │   │ away  = r (0–0.5) │
└───────────────────┘   └───────────────────┘   └───────────────────┘
          │                         │                         │
          ▼                         ▼                         ▼
┌───────────────────────────────────────────────────────────────────┐
│                      GEOMETRY FUNCTION                            │
│         (operates in along/away space, same for all coords)       │
└───────────────────────────────────────────────────────────────────┘
          │                         │                         │
          │                         │                         ▼
          │                         │              ┌───────────────────┐
          │                         │              │ Polar segmentation│
          │                         │              │ (add vertices for │
          │                         │              │  smooth curves)   │
          │                         │              └───────────────────┘
          │                         │                         │
          ▼                         ▼                         ▼
┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
│ FINAL CONVERSION  │   │ FINAL CONVERSION  │   │ FINAL CONVERSION  │
├───────────────────┤   ├───────────────────┤   ├───────────────────┤
│ x = along         │   │ x = away          │   │ x = 0.5 + r×sin(θ)│
│ y = away          │   │ y = along         │   │ y = 0.5 + r×cos(θ)│
└───────────────────┘   └───────────────────┘   └───────────────────┘
          │                         │                         │
          └─────────────────────────┼─────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           GRID GROB                                         │
│                      (x, y in NPC units)                                    │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<div class="section level3">
<h3 id="important-alongaway-are-not-always-npc">Important: Along/Away Are Not Always NPC<a class="anchor" aria-label="anchor" href="#important-alongaway-are-not-always-npc"></a>
</h3>
<p>A key subtlety is that along/away values represent different things
depending on the coordinate system:</p>
<ul>
<li><p><strong>Cartesian/Flipped</strong>: Along and away are NPC
(normalised parent coordinates), scaled 0-1. The transformation from
data to NPC happens via <code>coord$transform()</code> and is complete
at this point.</p></li>
<li><p><strong>Polar</strong>: Along is theta (radians, 0 to 2π) and
away is r (radius, scaled 0–0.5). These are <em>not</em> NPC—they’re
polar coordinates that still need to be converted to Cartesian NPC for
grid to draw.</p></li>
</ul>
<p>This means the data-to-NPC transformation happens at different
stages:</p>
<pre><code>Cartesian: data → coord$transform() → NPC (stored as along/away) → grid
Polar:     data → coord$transform() → θ/r (stored as along/away) → trig conversion → NPC → grid</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="the-compose_grob-pipeline">The compose_grob() Pipeline<a class="anchor" aria-label="anchor" href="#the-compose_grob-pipeline"></a>
</h2>
<p>To encapsulate this complexity, gggenes uses a
<code>compose_grob()</code> function that handles the entire
transformation pipeline from raw data to final grob. This function:</p>
<ol style="list-style-type: decimal">
<li>Detects the coordinate system</li>
<li>Transforms data to along/away coordinates</li>
<li>Converts unit measurements (mm, etc.) to along/away values</li>
<li>Calls a geometry function with the transformed values</li>
<li>Segments the geometry for polar coordinates (so curves appear
smooth)</li>
<li>Converts along/away to grid NPC coordinates</li>
<li>Creates and returns the appropriate grob</li>
</ol>
<div class="section level3">
<h3 id="geometry-functions">Geometry Functions<a class="anchor" aria-label="anchor" href="#geometry-functions"></a>
</h3>
<p>Geometry is defined as a regular R function that receives a data row
with transformed coordinates, and returns the polygon or polyline
vertices:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_arrow_geometry</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_row</span>, <span class="va">gt</span>, <span class="va">as_along</span>, <span class="va">as_away</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Extract transformed coordinates from data_row</span></span>
<span>  <span class="va">along_min</span> <span class="op">&lt;-</span> <span class="va">data_row</span><span class="op">$</span><span class="va">along_min</span></span>
<span>  <span class="va">along_max</span> <span class="op">&lt;-</span> <span class="va">data_row</span><span class="op">$</span><span class="va">along_max</span></span>
<span>  <span class="va">away</span> <span class="op">&lt;-</span> <span class="va">data_row</span><span class="op">$</span><span class="va">away</span></span>
<span></span>
<span>  <span class="co"># Convert units using the converter functions</span></span>
<span>  <span class="va">arrowhead_along</span> <span class="op">&lt;-</span> <span class="fu">as_along</span><span class="op">(</span><span class="va">gt</span><span class="op">$</span><span class="va">arrowhead_width</span><span class="op">)</span></span>
<span>  <span class="va">arrowhead_away</span> <span class="op">&lt;-</span> <span class="fu">as_away</span><span class="op">(</span><span class="va">gt</span><span class="op">$</span><span class="va">arrowhead_height</span><span class="op">)</span></span>
<span>  <span class="va">body_away</span> <span class="op">&lt;-</span> <span class="fu">as_away</span><span class="op">(</span><span class="va">gt</span><span class="op">$</span><span class="va">arrow_body_height</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Compute intermediate values</span></span>
<span>  <span class="va">orientation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">along_max</span> <span class="op">&gt;</span> <span class="va">along_min</span>, <span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">arrowhead_along_clamped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">arrowhead_along</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">along_max</span> <span class="op">-</span> <span class="va">along_min</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">along_max</span> <span class="op">-</span> <span class="va">along_min</span><span class="op">)</span>,</span>
<span>    <span class="va">arrowhead_along</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">flange</span> <span class="op">&lt;-</span> <span class="va">along_max</span> <span class="op">-</span> <span class="va">orientation</span> <span class="op">*</span> <span class="va">arrowhead_along_clamped</span></span>
<span>  <span class="va">arrowhead_away_half</span> <span class="op">&lt;-</span> <span class="va">arrowhead_away</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>  <span class="va">body_away_half</span> <span class="op">&lt;-</span> <span class="va">body_away</span> <span class="op">/</span> <span class="fl">2</span></span>
<span></span>
<span>  <span class="co"># Return vertex coordinates</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    alongs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">along_min</span>, <span class="va">along_min</span>, <span class="va">flange</span>, <span class="va">flange</span>, <span class="va">along_max</span>, <span class="va">flange</span>, <span class="va">flange</span><span class="op">)</span>,</span>
<span>    aways <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">away</span> <span class="op">+</span> <span class="va">body_away_half</span>,</span>
<span>      <span class="va">away</span> <span class="op">-</span> <span class="va">body_away_half</span>,</span>
<span>      <span class="va">away</span> <span class="op">-</span> <span class="va">body_away_half</span>,</span>
<span>      <span class="va">away</span> <span class="op">-</span> <span class="va">arrowhead_away_half</span>,</span>
<span>      <span class="va">away</span>,</span>
<span>      <span class="va">away</span> <span class="op">+</span> <span class="va">arrowhead_away_half</span>,</span>
<span>      <span class="va">away</span> <span class="op">+</span> <span class="va">body_away_half</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The function receives a standard interface:</p>
<ul>
<li>
<code>data_row</code>: A single-row data frame with transformed
coordinates. Contains <code>along</code> (for point geoms) or
<code>along_min</code>/<code>along_max</code> (for range geoms), plus
<code>away</code>. For subgene geoms, also contains
<code>along_submin</code>/<code>along_submax</code>.</li>
<li>
<code>gt</code>: The gTree object containing geom-specific
parameters as <code><a href="https://rdrr.io/r/grid/unit.html" class="external-link">grid::unit()</a></code> objects (e.g.,
<code>gt$arrowhead_width</code>).</li>
<li>
<code>as_along</code>: Function to convert a
<code><a href="https://rdrr.io/r/grid/unit.html" class="external-link">grid::unit()</a></code> to native along-units.</li>
<li>
<code>as_away</code>: Function to convert a
<code><a href="https://rdrr.io/r/grid/unit.html" class="external-link">grid::unit()</a></code> to native away-units.</li>
</ul>
<p>All coordinate values in <code>data_row</code> are already
transformed to along/away space. The geometry function converts unit
measurements as needed using the converter functions.</p>
</div>
<div class="section level3">
<h3 id="unit-conversion">Unit Conversion<a class="anchor" aria-label="anchor" href="#unit-conversion"></a>
</h3>
<p>Converting absolute measurements to along/away values requires
knowing:</p>
<ol style="list-style-type: decimal">
<li>The coordinate system (determines which grid dimension to
convert)</li>
<li>For polar “along”, the current radius (angular size scales inversely
with radius)</li>
</ol>
<p><code>compose_grob()</code> creates the <code>as_along</code> and
<code>as_away</code> converter functions that close over these
values:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inside compose_grob():</span></span>
<span><span class="va">as_along</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"cartesian"</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html" class="external-link">convertWidth</a></span><span class="op">(</span><span class="va">unit</span>, <span class="st">"native"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"polar"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html" class="external-link">convertWidth</a></span><span class="op">(</span><span class="va">unit</span>, <span class="st">"native"</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">r</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"flip"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html" class="external-link">convertHeight</a></span><span class="op">(</span><span class="va">unit</span>, <span class="st">"native"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">as_away</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"cartesian"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html" class="external-link">convertHeight</a></span><span class="op">(</span><span class="va">unit</span>, <span class="st">"native"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"polar"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html" class="external-link">convertHeight</a></span><span class="op">(</span><span class="va">unit</span>, <span class="st">"native"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"flip"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.convert.html" class="external-link">convertWidth</a></span><span class="op">(</span><span class="va">unit</span>, <span class="st">"native"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="polar-segmentation">Polar Segmentation<a class="anchor" aria-label="anchor" href="#polar-segmentation"></a>
</h3>
<p>ggplot2 draws polar-coordinate plots by defining them in Cartesian
coordinates that are passed to grid. Grid doesn’t know it’s drawing a
polar-coordinate plot. Hence, a straight line in a polar-coordinate plot
cannot be defined as a line between two points, as this would be drawn
as a straight chord rather than an arc. To make lines follow the polar
geometry, they must be broken into many small segments before conversion
to Cartesian coordinates. In ggplot2, this is known as ‘munching’. This
segmentation is handled automatically by
<code>compose_grob()</code>.</p>
<p>The segmentation algorithm works as follows:</p>
<ol style="list-style-type: decimal">
<li>For each pair of consecutive vertices (with wrap-around for
polygons), calculate a “length” in polar space:
<code>sqrt((Δr)² + (Δθ)²)</code>
</li>
<li>Create <code>round(length * 100)</code> segments between the
vertices—approximately 100 segments per unit of combined polar
distance</li>
<li>Linearly interpolate both r and θ to create the intermediate
points</li>
<li>For polylines, the algorithm respects <code>id</code> groupings to
keep separate line segments separate</li>
</ol>
<p>Note that <code>compose_grob()</code> includes handling for the
special case where theta wraps around at 0/2π. When a range geom’s
endpoint transforms to exactly 0 radians but should logically be 2π
(based on the original data ordering), the value is corrected. However,
geometries that truly span across the 0/2π boundary (e.g., from 350° to
10°) are not currently supported and would need to be split into two
separate geometries.</p>
</div>
<div class="section level3">
<h3 id="final-conversion">Final Conversion<a class="anchor" aria-label="anchor" href="#final-conversion"></a>
</h3>
<p>After geometry is computed in along/away space, it’s converted to
grid x/y:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"cartesian"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">alongs</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">aways</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"polar"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="va">aways</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">alongs</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="va">aways</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">alongs</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">coord_system</span> <span class="op">==</span> <span class="st">"flip"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">aways</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">alongs</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For polar, this is the standard polar-to-Cartesian conversion,
centered at (0.5, 0.5) in the viewport.</p>
</div>
</div>
<div class="section level2">
<h2 id="putting-it-together">Putting It Together<a class="anchor" aria-label="anchor" href="#putting-it-together"></a>
</h2>
<p>With this architecture:</p>
<ul>
<li>
<code>draw_panel()</code> is minimal; it just packages data, coord,
and panel_scales into a gTree</li>
<li>
<code>makeContent()</code> defines units and the
<code>geometry()</code> function, then iterates over data rows calling
<code>compose_grob()</code> for each</li>
<li>
<code>compose_grob()</code> encapsulates the coordinate
transformation pipeline, which is independent of the geometry of any
individual geom</li>
</ul>
<p>This makes it straightforward to add new geoms: define a geometry
function and unit specifications, then call <code>compose_grob()</code>
with the appropriate grob type. Currently, <code>compose_grob()</code>
supports three grob types:</p>
<ul>
<li>
<code>"polygon"</code>: Creates a closed polygon using
<code><a href="https://rdrr.io/r/grid/grid.polygon.html" class="external-link">grid::polygonGrob()</a></code>
</li>
<li>
<code>"polyline"</code>: Creates open line(s) using
<code><a href="https://rdrr.io/r/grid/grid.lines.html" class="external-link">grid::polylineGrob()</a></code>, with optional <code>id</code> vector
for multiple segments and <code>arrow</code> parameter for
arrowheads</li>
<li>
<code>"text"</code>: Creates a text label using ggfittext. The
geometry function returns a bounding box (<code>along_min</code>,
<code>along_max</code>, <code>away_min</code>, <code>away_max</code>)
instead of vertices. Text styling (fontface, colour, etc.) comes from
<code>data_row</code> columns rather than the <code>gp</code>
parameter</li>
</ul>
<div class="section level3">
<h3 id="example-complete-makecontent-implementation">Example: Complete makeContent Implementation<a class="anchor" aria-label="anchor" href="#example-complete-makecontent-implementation"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">makeContent.genearrowtree</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">data</span></span>
<span></span>
<span>  <span class="co"># Define geometry function with standard interface</span></span>
<span>  <span class="va">geometry</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_row</span>, <span class="va">gt</span>, <span class="va">as_along</span>, <span class="va">as_away</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Extract transformed coordinates</span></span>
<span>    <span class="va">along_min</span> <span class="op">&lt;-</span> <span class="va">data_row</span><span class="op">$</span><span class="va">along_min</span></span>
<span>    <span class="va">along_max</span> <span class="op">&lt;-</span> <span class="va">data_row</span><span class="op">$</span><span class="va">along_max</span></span>
<span>    <span class="va">away</span> <span class="op">&lt;-</span> <span class="va">data_row</span><span class="op">$</span><span class="va">away</span></span>
<span></span>
<span>    <span class="co"># Convert units</span></span>
<span>    <span class="va">arrowhead_along</span> <span class="op">&lt;-</span> <span class="fu">as_along</span><span class="op">(</span><span class="va">gt</span><span class="op">$</span><span class="va">arrowhead_width</span><span class="op">)</span></span>
<span>    <span class="va">arrowhead_away</span> <span class="op">&lt;-</span> <span class="fu">as_away</span><span class="op">(</span><span class="va">gt</span><span class="op">$</span><span class="va">arrowhead_height</span><span class="op">)</span></span>
<span>    <span class="va">body_away</span> <span class="op">&lt;-</span> <span class="fu">as_away</span><span class="op">(</span><span class="va">gt</span><span class="op">$</span><span class="va">arrow_body_height</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Compute geometry</span></span>
<span>    <span class="va">orientation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">along_max</span> <span class="op">&gt;</span> <span class="va">along_min</span>, <span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">arrowhead_along_clamped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>      <span class="va">arrowhead_along</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">along_max</span> <span class="op">-</span> <span class="va">along_min</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">along_max</span> <span class="op">-</span> <span class="va">along_min</span><span class="op">)</span>,</span>
<span>      <span class="va">arrowhead_along</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">flange</span> <span class="op">&lt;-</span> <span class="va">along_max</span> <span class="op">-</span> <span class="va">orientation</span> <span class="op">*</span> <span class="va">arrowhead_along_clamped</span></span>
<span>    <span class="va">arrowhead_away_half</span> <span class="op">&lt;-</span> <span class="va">arrowhead_away</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>    <span class="va">body_away_half</span> <span class="op">&lt;-</span> <span class="va">body_away</span> <span class="op">/</span> <span class="fl">2</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      alongs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="va">along_min</span>,</span>
<span>        <span class="va">along_min</span>,</span>
<span>        <span class="va">flange</span>,</span>
<span>        <span class="va">flange</span>,</span>
<span>        <span class="va">along_max</span>,</span>
<span>        <span class="va">flange</span>,</span>
<span>        <span class="va">flange</span></span>
<span>      <span class="op">)</span>,</span>
<span>      aways <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="va">away</span> <span class="op">+</span> <span class="va">body_away_half</span>,</span>
<span>        <span class="va">away</span> <span class="op">-</span> <span class="va">body_away_half</span>,</span>
<span>        <span class="va">away</span> <span class="op">-</span> <span class="va">body_away_half</span>,</span>
<span>        <span class="va">away</span> <span class="op">-</span> <span class="va">arrowhead_away_half</span>,</span>
<span>        <span class="va">away</span>,</span>
<span>        <span class="va">away</span> <span class="op">+</span> <span class="va">arrowhead_away_half</span>,</span>
<span>        <span class="va">away</span> <span class="op">+</span> <span class="va">body_away_half</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Prepare grob for each gene</span></span>
<span>  <span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gene</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span></span>
<span>    <span class="co"># Reverse non-forward genes</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">gene</span><span class="op">$</span><span class="va">forward</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">gene</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"xmin"</span>, <span class="st">"xmax"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">gene</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"xmax"</span>, <span class="st">"xmin"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Set up graphical parameters</span></span>
<span>    <span class="va">gp</span> <span class="op">&lt;-</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span></span>
<span>      fill <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="va">gene</span><span class="op">$</span><span class="va">fill</span>, <span class="va">gene</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span>,</span>
<span>      col <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html" class="external-link">alpha</a></span><span class="op">(</span><span class="va">gene</span><span class="op">$</span><span class="va">colour</span>, <span class="va">gene</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span>,</span>
<span>      lty <span class="op">=</span> <span class="va">gene</span><span class="op">$</span><span class="va">linetype</span>,</span>
<span>      lwd <span class="op">=</span> <span class="va">gene</span><span class="op">$</span><span class="va">linewidth</span> <span class="op">*</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/graphical-units.html" class="external-link">.pt</a></span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu">compose_grob</span><span class="op">(</span></span>
<span>      geometry_fn <span class="op">=</span> <span class="va">geometry</span>,</span>
<span>      gt <span class="op">=</span> <span class="va">x</span>,</span>
<span>      data_row <span class="op">=</span> <span class="va">gene</span>,</span>
<span>      grob_type <span class="op">=</span> <span class="st">"polygon"</span>,</span>
<span>      gp <span class="op">=</span> <span class="va">gp</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">grobs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"gList"</span></span>
<span>  <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.add.html" class="external-link">setChildren</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">grobs</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Wilkins.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
